---
title: Defense CSRF Attacks
search: true
tags: 
  - CSRF
  - Security
toc: true
toc_label: "My Table of Contents"
toc_icon: "cog"
classes: wide
---

Protect trusted relationships from CSRF attacks.

## CSRF basic

A CSRF attack takes advantage of the trusted relationship (i.e., session) that exists between an application and a user’s browser, by tricking that user into submitting an unintended request to the application.

## A typical CSRF attack

1. The user A logins in web app B, which is good. In the broswer, it keeps the cookie for B.
2. The user A browses web app C, which is a malicious web app.
3. The user A click a button in App C and hence issues a request using the cookie generated by App B.

```html
<form method="post" action="http://malicious.com/transfer-funds">
    <button type="submit" class="btn btn-primary">
        Click Here To Get an iPhone for FREE!
    </button>
</form>
```

## Defend a CSRF attack

### synchronizer token pattern

In this approach, a random string is generated for each incoming request, which the client can subsequently access as part of a template’s context or via a response header. Importantly, this string is not stored as a cookie. The next POST, PUT, PATCH, or DELETE request made by the client must include this string, which the server will then compare with the one it previously generated.

```html
<form method="post" action="/sessions">
    <input type="hidden" name="_csrf" value="116d8f8b-90dd-49da-8a59-d27a4481941e">
</form>
```

Explained:

1. In the normal process
    1. The user A logins in web app B, which is good. We get the cookie.
    2. The user A issues a post request in B. In the request, it includes a _csrf generated by App B.
    3. the App B server varifies the token. It's from App B, looks all good.

2. Then the user A opens the malicious app C
    1. In App C, our user A clicks a button which issues a request to App B, using the cookie form App B. It's dangerous!
    2. The request, which generated by malicious App C, cannot fake the csrf token. Because even there is a form, it's generated by App C, not App B.
    3. The App B's server found that the request don't have the csrf token (or it's wrong), refuses the request.

## References

- [javascript frameworks for modern web development 2nd edition](https://www.amazon.com/JavaScript-Frameworks-Modern-Web-Development/dp/1484249941)
- [3 Steps to Implement Simple CSRF Token in PHP](https://code-boxx.com/simple-csrf-token-php/)
